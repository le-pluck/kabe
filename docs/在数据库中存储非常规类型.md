# 在数据库中存储非常规类型

## json

JSON 类型是从MySQL 5.7 版本开始支持的功能，而 8.0 版本解决了更新 JSON 的日志性能瓶颈。

因此现在可以较好地在 MySQL database 中存储 json 数据了。

### Database

| 字段   | 含义        |   类型    |
| :---- | :---------- | -------- |
| `id`  | 主键        | `bigint` |
| ...   | ...         | ...      |
| `ops` | 帖子数据模型 | `json`   |

### Model

``` java
@Data
@TableName(autoResultMap = true)
public class Post {
    @TableId(type = IdType.AUTO)
    private Long id;
    // ...
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<Object> ops;

    // ...
}
```

+ 这里 TypeHandler 有两种选择
    + `JacksonTypeHandler`
    + `FastjsonTypeHandler`

+ `JacksonTypeHandler` VS `FastjsonTypeHandler`
    + `JacksonTypeHandler`
        + 支持 MVC JSON 解析
        + 支持 MySQL JSON 解析
    + `FastjsonTypeHandler`
        + 支持 MVC JSON 解析
        + 不支持 MySQL JSON 解析
            + Ps：可以通过 XML 支持，只是会失去 MP 特性。

+ 注意事项：
    + MVC JSON 解析时，可以不用加  `@TableName(autoResultMap = true)`
    + MySQL JSON 解析查询的时候，如果不加，查出来为 `null`


## longtext

在 DB 中：

| 类型       | 大小限制     |
| :--------- | :---------- |
| `varchar`  | 65535 Bytes |
| `longtext` | 4 GB        |

在 Java 中：

| 类型            | 大小限制     |
| :-------------- | :---------- |
| `String` 编译期 | 65535 Bytes |
| `String` 运行时 | 4 GB        |

因此选择 `longtext -> String` 的映射是很好的。

+ **关于 Java String 大小限制**：

Java 的 String 构造函数如下

``` java
public String(char value[], int offset, int count) {
    // ...
}
```

可见 String 的最大长度取决于管理 `char` 数组长度的 `int count` 字段。`int` 占四个字节，取值区间为 $[-2^{31}, 2^{31} - 1]$。而 `char` 大小也是 2 Bytes，因此 String 的最大大小为 $(2^{31} - 1) * 2 Bytes \approx 2^{32} Bytes = 4GB$；



### Database

| 字段   | 含义      |    类型     |
| :----- | :-------- | ---------- |
| `id`   | 主键      | `bigint`   |
| ...    | ...       | ...        |
| `html` | 帖子 HTML | `longtext` |

### Model

``` java
@Data
@TableName(autoResultMap = true)
public class Post {
    @TableId(type = IdType.AUTO)
    private Long id;
    // ...
    @TableField(typeHandler = LongTextTypeHandler.class)
    private String html;

    // ...
}
```

+ 这里 TypeHandler 是自定义的

### TypeHandler

``` java
public class LongTextTypeHandler extends BaseTypeHandler<String> {
    @Override
    public void setNonNullParameter(PreparedStatement preparedStatement, int i, String s, JdbcType jdbcType) throws SQLException {
        preparedStatement.setString(i, s);
    }

    @Override
    public String getNullableResult(ResultSet resultSet, String s) throws SQLException {
        return resultSet.getString(s);
    }

    @Override
    public String getNullableResult(ResultSet resultSet, int i) throws SQLException {
        return resultSet.getString(i);
    }

    @Override
    public String getNullableResult(CallableStatement callableStatement, int i) throws SQLException {
        return callableStatement.getString(i);
    }
}
```
